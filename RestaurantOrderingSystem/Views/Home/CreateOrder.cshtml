@model RestaurantOrderingSystem.Models.CreateOrderViewModel
@{
    ViewData["Title"] = "Create Order";
}

@section Styles {
    <link rel="stylesheet" href="~/css/forms.css" asp-append-version="true" />
    <style>
        .order-items-container {
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .order-item-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: end;
        }

        .item-details {
            flex: 1;
        }

        .item-actions {
            width: 100px;
        }

        .add-item-btn {
            margin-bottom: 15px;
        }

        .item-price {
            font-weight: 600;
            color: #28a745;
        }
    </style>
}

<div class="form-container">
    <div class="card form-card">
        <div class="card-header form-header">
            <h2 class="text-center mb-0"><i class="fas fa-plus-circle me-2"></i>Create New Order</h2>
        </div>
        <div class="card-body p-4">
            <form asp-action="CreateOrder" method="post" id="orderForm">
                <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                <div class="form-input-group">
                    <label class="form-label">Order No.</label>
                    <input asp-for="OrderNo" class="form-control" readonly placeholder="Auto-generated" />
                </div>

                <div class="form-input-group">
                    <label class="form-label">Customer Name</label>
                    <input asp-for="Customer" class="form-control" placeholder="Enter customer name" />
                    <span asp-validation-for="Customer" class="text-danger small"></span>
                </div>

                <!-- Order Items Section -->
                <div class="form-input-group">
                    <label class="form-label">Order Items</label>
                    <div class="order-items-container">
                        <button type="button" class="btn btn-outline-primary btn-sm add-item-btn" onclick="addOrderItem()">
                            <i class="fas fa-plus me-1"></i>Add Item
                        </button>

                        <div id="orderItemsContainer">
                            @for (int i = 0; i < Model.OrderItems.Count; i++)
                            {
                                <div class="order-item-row" data-index="@i">
                                    <div class="item-details">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label small">Item Name</label>
                                                <select asp-for="OrderItems[i].ItemName" class="form-select item-select" onchange="updateItemPrice(this)">
                                                    <option value="">-- Select Food --</option>
                                                    <option value="Fried Chicken">Fried Chicken - ₱25</option>
                                                    <option value="Burger Steak">Burger Steak - ₱30</option>
                                                    <option value="Spaghetti">Spaghetti - ₱20</option>
                                                    <option value="Pancit Canton">Pancit Canton - ₱18</option>
                                                    <option value="Sisig">Sisig - ₱28</option>
                                                    <option value="Lechon Kawali">Lechon Kawali - ₱32</option>
                                                    <option value="Adobo">Adobo - ₱27</option>
                                                    <option value="Beef Tapa">Beef Tapa - ₱35</option>
                                                    <option value="Sinigang">Sinigang - ₱33</option>
                                                    <option value="Halo-Halo">Halo-Halo - ₱15</option>
                                                    <option value="Caesar Salad">Caesar Salad - ₱22</option>
                                                    <option value="Garlic Rice">Garlic Rice - ₱12</option>
                                                    <option value="Soft Drinks">Soft Drinks - ₱15</option>
                                                    <option value="Iced Tea">Iced Tea - ₱12</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small">Quantity</label>
                                                <input asp-for="OrderItems[i].Quantity" class="form-control quantity-input" type="number" min="1" value="1" onchange="updateItemTotal(this)" />
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small">Price</label>
                                                <div class="d-flex align-items-center h-100">
                                                    <span class="item-price">₱<span class="item-total">0.00</span></span>
                                                    <input type="hidden" asp-for="OrderItems[i].UnitPrice" class="unit-price" />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="item-actions">
                                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeOrderItem(this)" @(Model.OrderItems.Count <= 1 ? "disabled" : "")>
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Order Summary -->
                <div class="form-input-group bg-light p-3 rounded">
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="mb-3">Order Summary</h5>
                            <div id="orderSummary">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <h4>Total: ₱<span id="grandTotal">0.00</span></h4>
                        </div>
                    </div>
                </div>

                <div class="form-input-group">
                    <label class="form-label">Payment Method</label>
                    <select asp-for="PaymentMethod" class="form-select">
                        <option value="">-- Choose Payment Method --</option>
                        <option value="Gcash">Gcash</option>
                        <option value="Cash">Cash</option>
                        <option value="Credit Card">Credit Card</option>
                        <option value="PayMaya">PayMaya</option>
                        <option value="ShopeePay">ShopeePay</option>
                    </select>
                    <span asp-validation-for="PaymentMethod" class="text-danger small"></span>
                </div>

                <!-- Table Reservation Section -->
                <div class="form-input-group">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" asp-for="NeedTableReservation" id="needReservation" onchange="toggleReservationSection()">
                        <label class="form-check-label" for="needReservation">
                            <strong>I need a table reservation</strong>
                        </label>
                    </div>
                </div>

                <div id="reservationSection" style="display: none;">
                    <div class="row">
                        <div class="col-md-6 form-input-group">
                            <label class="form-label">Table Number</label>
                            <select asp-for="TableNumber" class="form-select">
                                <option value="">-- Select Table --</option>
                                <option value="T01">Table 01 (2 persons)</option>
                                <option value="T02">Table 02 (2 persons)</option>
                                <option value="T03">Table 03 (4 persons)</option>
                                <option value="T04">Table 04 (4 persons)</option>
                                <option value="T05">Table 05 (6 persons)</option>
                                <option value="T06">Table 06 (6 persons)</option>
                                <option value="VIP1">VIP Room 1 (8 persons)</option>
                                <option value="VIP2">VIP Room 2 (10 persons)</option>
                            </select>
                        </div>
                        <div class="col-md-6 form-input-group">
                            <label class="form-label">Number of Guests</label>
                            <input asp-for="NumberOfGuests" class="form-control" type="number" min="1" max="20" value="2" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 form-input-group">
                            <label class="form-label">Reservation Date</label>
                            <input asp-for="ReservationDate" class="form-control" type="date" min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                        </div>
                        <div class="col-md-6 form-input-group">
                            <label class="form-label">Reservation Time</label>
                            <select asp-for="ReservationTime" class="form-select">
                                <option value="10:00">10:00 AM</option>
                                <option value="11:00">11:00 AM</option>
                                <option value="12:00">12:00 PM</option>
                                <option value="13:00">1:00 PM</option>
                                <option value="14:00">2:00 PM</option>
                                <option value="17:00">5:00 PM</option>
                                <option value="18:00" selected>6:00 PM</option>
                                <option value="19:00">7:00 PM</option>
                                <option value="20:00">8:00 PM</option>
                                <option value="21:00">9:00 PM</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-input-group">
                        <label class="form-label">Special Requests (Optional)</label>
                        <textarea asp-for="SpecialRequests" class="form-control" rows="3" placeholder="Any special requests or dietary restrictions..."></textarea>
                    </div>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                    <a asp-action="UserDashboard" class="btn btn-secondary form-btn-secondary me-md-2">Cancel</a>
                    <button type="submit" class="btn form-btn-primary">Create Order</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        const foodPrices = {
            "Fried Chicken": 25, "Burger Steak": 30, "Spaghetti": 20, "Pancit Canton": 18,
            "Sisig": 28, "Lechon Kawali": 32, "Adobo": 27, "Beef Tapa": 35,
            "Sinigang": 33, "Halo-Halo": 15, "Caesar Salad": 22, "Garlic Rice": 12,
            "Soft Drinks": 15, "Iced Tea": 12
        };

        let itemCounter = @Model.OrderItems.Count;

        function addOrderItem() {
            const container = document.getElementById('orderItemsContainer');
            const newIndex = itemCounter++;

            const newItemHtml = `
                <div class="order-item-row" data-index="${newIndex}">
                    <div class="item-details">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label small">Item Name</label>
                                <select name="OrderItems[${newIndex}].ItemName" class="form-select item-select" onchange="updateItemPrice(this)">
                                    <option value="">-- Select Food --</option>
                                    ${Object.keys(foodPrices).map(item =>
                                        `<option value="${item}">${item} - ₱${foodPrices[item]}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">Quantity</label>
                                <input name="OrderItems[${newIndex}].Quantity" class="form-control quantity-input" type="number" min="1" value="1" onchange="updateItemTotal(this)" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">Price</label>
                                <div class="d-flex align-items-center h-100">
                                    <span class="item-price">₱<span class="item-total">0.00</span></span>
                                    <input type="hidden" name="OrderItems[${newIndex}].UnitPrice" class="unit-price" value="0" />
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="item-actions">
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeOrderItem(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', newItemHtml);
            updateOrderSummary();
        }

        function removeOrderItem(button) {
            const row = button.closest('.order-item-row');
            row.remove();
            updateOrderSummary();
            updateRemoveButtons();
        }

        function updateRemoveButtons() {
            const rows = document.querySelectorAll('.order-item-row');
            const removeButtons = document.querySelectorAll('.order-item-row .btn-outline-danger');
            removeButtons.forEach(btn => {
                btn.disabled = rows.length <= 1;
            });
        }

        function updateItemPrice(select) {
            const row = select.closest('.order-item-row');
            const itemName = select.value;
            const unitPrice = foodPrices[itemName] || 0;
            const quantityInput = row.querySelector('.quantity-input');
            const unitPriceInput = row.querySelector('.unit-price');
            const totalSpan = row.querySelector('.item-total');

            unitPriceInput.value = unitPrice;
            const quantity = parseInt(quantityInput.value) || 1;
            const total = unitPrice * quantity;
            totalSpan.textContent = total.toFixed(2);

            updateOrderSummary();
        }

        function updateItemTotal(input) {
            const row = input.closest('.order-item-row');
            const select = row.querySelector('.item-select');
            updateItemPrice(select);
        }

        function updateOrderSummary() {
            let grandTotal = 0;
            const summaryContainer = document.getElementById('orderSummary');
            const grandTotalSpan = document.getElementById('grandTotal');

            const items = [];
            document.querySelectorAll('.order-item-row').forEach(row => {
                const itemName = row.querySelector('.item-select').value;
                const quantity = parseInt(row.querySelector('.quantity-input').value) || 0;
                const unitPrice = parseFloat(row.querySelector('.unit-price').value) || 0;
                const total = unitPrice * quantity;

                if (itemName && quantity > 0) {
                    items.push({ itemName, quantity, unitPrice, total });
                    grandTotal += total;
                }
            });

            // Update summary display
            if (items.length > 0) {
                summaryContainer.innerHTML = items.map(item =>
                    `<div class="small">${item.quantity} x ${item.itemName} = ₱${item.total.toFixed(2)}</div>`
                ).join('');
            } else {
                summaryContainer.innerHTML = '<div class="text-muted small">No items added</div>';
            }

            grandTotalSpan.textContent = grandTotal.toFixed(2);
        }

        function toggleReservationSection() {
            const reservationSection = document.getElementById('reservationSection');
            const needReservation = document.getElementById('needReservation').checked;
            reservationSection.style.display = needReservation ? 'block' : 'none';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize prices for existing items
            document.querySelectorAll('.item-select').forEach(select => {
                if (select.value) {
                    updateItemPrice(select);
                }
            });
            updateOrderSummary();
            updateRemoveButtons();
        });
    </script>
}