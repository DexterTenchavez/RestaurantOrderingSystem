@model RestaurantOrderingSystem.Models.Order
@{
    ViewData["Title"] = "Edit Order";
}

@section Styles {
    <link rel="stylesheet" href="~/css/forms.css" asp-append-version="true" />
}

<div class="form-container">
    <div class="card form-card">
        <div class="card-header form-header">
            <h2 class="text-center mb-0"><i class="fas fa-edit me-2"></i>Edit My Order</h2>
        </div>
        <div class="card-body p-4">
            <form asp-action="UserEdit" method="post" id="orderForm">
                <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                <input type="hidden" asp-for="Id" />

                <div class="row">
                    <div class="col-md-6 form-input-group">
                        <label class="form-label">Order No.</label>
                        <input asp-for="OrderNo" class="form-control" readonly />
                    </div>
                    <div class="col-md-6 form-input-group">
                        <label class="form-label">Customer Name</label>
                        <input asp-for="Customer" class="form-control" placeholder="Enter customer name" />
                        <span asp-validation-for="Customer" class="text-danger small"></span>
                    </div>
                </div>

                <!-- Order Items Section -->
                <div class="form-input-group">
                    <label class="form-label">Select Food Items</label>
                    <div class="food-search mb-3">
                        <input type="text" id="foodSearch" class="form-control" placeholder="Search food items..." />
                    </div>
                    <div class="food-cards-container" id="foodCardsContainer">
                        <!-- Food cards will be generated by JavaScript -->
                    </div>
                </div>

                <!-- Order Summary -->
                <div class="order-summary-container">
                    <h5 class="mb-3"><i class="fas fa-receipt me-2"></i>Order Summary</h5>
                    <div id="orderSummary" class="order-summary-items">
                        <div class="empty-state">
                            <i class="fas fa-shopping-cart"></i>
                            <p>No items selected</p>
                        </div>
                    </div>
                    <div class="order-total text-end mt-3">
                        <h4>Total: ₱<span id="grandTotal">@Model.TotalPrice.ToString("N2")</span></h4>
                    </div>
                </div>

                <!-- Hidden fields for order items -->
                <div id="orderItemsFields"></div>

                <div class="form-input-group">
                    <label class="form-label">Payment Method</label>
                    <select asp-for="PaymentMethod" class="form-select">
                        <option value="">-- Choose Payment Method --</option>
                        <option value="Gcash">Gcash</option>
                        <option value="Cash">Cash</option>
                        <option value="Credit Card">Credit Card</option>
                        <option value="PayMaya">PayMaya</option>
                        <option value="ShopeePay">ShopeePay</option>
                    </select>
                    <span asp-validation-for="PaymentMethod" class="text-danger small"></span>
                </div>

                <!-- Table Reservation Section -->
                @if (Model.TableReservation != null)
                {
                    <div class="form-input-group">
                        <label class="form-label">Current Table Reservation</label>
                        <div class="table-reservation-info bg-light p-3 rounded">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Table @Model.TableReservation.TableNumber</strong>
                                    <div class="small text-muted">
                                        @Model.TableReservation.NumberOfGuests guests<br>
                                        @Model.TableReservation.ReservationDate.ToString("MMM dd, yyyy") at @Model.TableReservation.ReservationTime.ToString(@"hh\:mm")
                                    </div>
                                </div>
                                <div class="col-md-6 text-end">
                                    <small class="text-muted">To modify reservation, please contact staff</small>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                    <a asp-action="UserDashboard" class="btn btn-outline-secondary form-btn-secondary me-md-2">
                        <i class="fas fa-arrow-left me-1"></i>Cancel
                    </a>
                    <button type="submit" class="btn form-btn-primary">
                        <i class="fas fa-check me-1"></i>Update Order
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Food data
        const foodItems = [
            { name: "Adobo", price: 27, image: "/images/Adobo.jpg", category: "Main" },
            { name: "Beef Tapa", price: 35, image: "/images/Beeftapa.jpg", category: "Main" },
            { name: "Burger Steak", price: 30, image: "/images/BurgerSteak.jpg", category: "Main" },
            { name: "Caesar Salad", price: 22, image: "/images/CaesarSalad.jpg", category: "Appetizer" },
            { name: "Fried Chicken", price: 25, image: "/images/FriedChicken.jpg", category: "Main" },
            { name: "Garlic Rice", price: 12, image: "/images/GarlicRice.jpg", category: "Side" },
            { name: "Halo-Halo", price: 15, image: "/images/Halo-halo.jpg", category: "Dessert" },
            { name: "Lechon Kawali", price: 32, image: "/images/LechonKawali.jpg", category: "Main" },
            { name: "Pancit Canton", price: 18, image: "/images/PancitCanton.jpg", category: "Main" },
            { name: "Sinigang", price: 33, image: "/images/Sinigang.jpg", category: "Main" },
            { name: "Sisig", price: 28, image: "/images/Sisig.jpg", category: "Main" },
            { name: "Soft Drinks", price: 15, image: "/images/softdrinks.jpg", category: "Drink" },
            { name: "Spaghetti", price: 20, image: "/images/Spaghetti.jpg", category: "Main" },
            { name: "Mini Sandwiches", price: 18, image: "/images/miniSandwiches.jpg", category: "Appetizer" },
            { name: "Grilled Asparagus", price: 20, image: "/images/Asparagus.jpg", category: "Appetizer" },
            { name: "Baked Mac & Cheese", price: 25, image: "/images/bakeMacCheese.jpg", category: "Side" },
            { name: "Leche Flan", price: 16, image: "/images/LecheFlan.jpg", category: "Dessert" },
            { name: "Chocolate Pudding", price: 14, image: "/images/chocolatePudding.jpg", category: "Dessert" },
            { name: "Iced Tea", price: 12, image: "/images/icedTea.webp", category: "Drink" }
        ];

        let selectedItems = {};

        // Initialize the page with existing order items
        document.addEventListener('DOMContentLoaded', function() {
            // Load existing order items into selectedItems
            @foreach (var item in Model.OrderItems)
            {
                    <text>
                    selectedItems["@item.ItemName"] = {
                        quantity: @item.Quantity,
                        price: @item.UnitPrice
                    };
                    </text>
            }

            initializeFoodCards();
            updateOrderSummary();
            updateHiddenFields();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Food search functionality
            document.getElementById('foodSearch').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const foodCards = document.querySelectorAll('.food-card');

                foodCards.forEach(card => {
                    const foodName = card.querySelector('.food-name').textContent.toLowerCase();
                    if (foodName.includes(searchTerm)) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
        }

        function initializeFoodCards() {
            const container = document.getElementById('foodCardsContainer');

            // Group by category
            const categories = {};
            foodItems.forEach(food => {
                if (!categories[food.category]) {
                    categories[food.category] = [];
                }
                categories[food.category].push(food);
            });

            // Create cards by category
            Object.keys(categories).forEach(category => {
                const categorySection = document.createElement('div');
                categorySection.className = 'food-category';
                categorySection.innerHTML = `<h6 class="category-title">${category}</h6>`;

                const categoryContainer = document.createElement('div');
                categoryContainer.className = 'food-cards-grid';

                categories[category].forEach(food => {
                    const existingQuantity = selectedItems[food.name] ? selectedItems[food.name].quantity : 0;

                    const card = document.createElement('div');
                    card.className = `food-card ${existingQuantity > 0 ? 'selected' : ''}`;
                    card.innerHTML = `
                        <img src="${food.image}" alt="${food.name}" class="food-image" onerror="this.style.backgroundColor='#f8f9fa'; this.alt='Food image not available';">
                        <div class="food-info">
                            <div class="food-name">${food.name}</div>
                            <div class="food-price">₱${food.price}</div>
                            <div class="quantity-controls">
                                <button type="button" class="quantity-btn decrease" onclick="decreaseQuantity('${food.name}')" ${existingQuantity === 0 ? 'disabled' : ''}>-</button>
                                <span class="quantity-display" id="qty-${food.name}">${existingQuantity}</span>
                                <button type="button" class="quantity-btn increase" onclick="increaseQuantity('${food.name}', ${food.price})">+</button>
                                <button type="button" class="quantity-btn cancel-btn" onclick="cancelFoodItem('${food.name}')" title="Remove all" style="display: ${existingQuantity > 0 ? 'inline-block' : 'none'};">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    categoryContainer.appendChild(card);
                });

                categorySection.appendChild(categoryContainer);
                container.appendChild(categorySection);
            });
        }

        function increaseQuantity(foodName, price) {
            if (!selectedItems[foodName]) {
                selectedItems[foodName] = { quantity: 0, price: price };
            }
            selectedItems[foodName].quantity++;

            updateQuantityDisplay(foodName);
            updateOrderSummary();
            updateHiddenFields();
        }

        function decreaseQuantity(foodName) {
            if (selectedItems[foodName] && selectedItems[foodName].quantity > 0) {
                selectedItems[foodName].quantity--;
                if (selectedItems[foodName].quantity === 0) {
                    delete selectedItems[foodName];
                }
                updateQuantityDisplay(foodName);
                updateOrderSummary();
                updateHiddenFields();
            }
        }

        // NEW FUNCTION: Cancel/Remove food item completely
        function cancelFoodItem(foodName) {
            if (selectedItems[foodName]) {
                delete selectedItems[foodName];
                updateQuantityDisplay(foodName);
                updateOrderSummary();
                updateHiddenFields();

                // Show success message
                showAlert(`Removed ${foodName} from order`, 'success');
            }
        }

        function updateQuantityDisplay(foodName) {
            const quantityDisplay = document.getElementById(`qty-${foodName}`);
            const quantity = selectedItems[foodName] ? selectedItems[foodName].quantity : 0;
            if (quantityDisplay) {
                quantityDisplay.textContent = quantity;
            }

            // Update button states
            const cards = document.querySelectorAll('.food-card');
            cards.forEach(card => {
                const nameElement = card.querySelector('.food-name');
                if (nameElement && nameElement.textContent === foodName) {
                    const decreaseBtn = card.querySelector('.decrease');
                    const cancelBtn = card.querySelector('.cancel-btn');

                    if (decreaseBtn) {
                        decreaseBtn.disabled = quantity === 0;
                    }

                    if (cancelBtn) {
                        // Show cancel button only when quantity > 0
                        cancelBtn.style.display = quantity > 0 ? 'inline-block' : 'none';
                    }

                    // Update card selection state
                    if (quantity > 0) {
                        card.classList.add('selected');
                    } else {
                        card.classList.remove('selected');
                    }
                }
            });
        }

        function updateOrderSummary() {
            const summaryContainer = document.getElementById('orderSummary');
            const grandTotalSpan = document.getElementById('grandTotal');

            let grandTotal = 0;
            let summaryHTML = '';

            Object.keys(selectedItems).forEach(foodName => {
                const item = selectedItems[foodName];
                const itemTotal = item.quantity * item.price;
                grandTotal += itemTotal;

                summaryHTML += `
                    <div class="order-item">
                        <div class="item-info">
                            <span class="item-name">${item.quantity} x ${foodName}</span>
                            <span class="item-price">₱${itemTotal.toFixed(2)}</span>
                        </div>
                        <button type="button" class="remove-item-btn" onclick="cancelFoodItem('${foodName}')" title="Remove item">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            });

            if (summaryHTML === '') {
                summaryHTML = `
                    <div class="empty-state">
                        <i class="fas fa-shopping-cart"></i>
                        <p>No items selected</p>
                    </div>
                `;
            } else {
                summaryHTML = `<div class="order-summary-items">${summaryHTML}</div>`;
            }

            summaryContainer.innerHTML = summaryHTML;
            grandTotalSpan.textContent = grandTotal.toFixed(2);
        }

        function updateHiddenFields() {
            const container = document.getElementById('orderItemsFields');
            container.innerHTML = '';

            let index = 0;
            Object.keys(selectedItems).forEach(foodName => {
                const item = selectedItems[foodName];
                container.innerHTML += `
                    <input type="hidden" name="OrderItems[${index}].ItemName" value="${foodName}" />
                    <input type="hidden" name="OrderItems[${index}].Quantity" value="${item.quantity}" />
                    <input type="hidden" name="OrderItems[${index}].UnitPrice" value="${item.price}" />
                `;
                index++;
            });
        }

        // Prepare form data before submission
        document.getElementById('orderForm').addEventListener('submit', function(e) {
            updateHiddenFields();

            // Validate that at least one item is selected
            if (Object.keys(selectedItems).length === 0) {
                e.preventDefault();
                showAlert('Please select at least one food item.', 'warning');
                return false;
            }

            return true;
        });

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            const form = document.getElementById('orderForm');
            form.insertBefore(alertDiv, form.firstChild);

            // Auto-dismiss success alerts after 3 seconds
            if (type === 'success') {
                setTimeout(() => {
                    alertDiv.remove();
                }, 3000);
            }
        }
    </script>
}